<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Material</title>
    <link rel="stylesheet" href="../../assets/css/global.css">
    <link rel="stylesheet" href="../../assets/css/material-css/cadastrar-material.css">
</head>

<body>
    <div class="container-geral">

        <header class="cabecalho">
            <h1 class="titulo-pagina">EDITAR <br> MATERIAL</h1>

            <button class="botao-fechar" type="button" aria-label="Fechar janela">
                <img src="../../assets/icons/botao-fechar.svg" alt="Botão fechar">
            </button>
        </header>

        <main class="conteudo-principal">
            <section class="secao-formulario">

                <form id="formulario" class="formulario" action="#" method="POST">

                    <div class="grupo-campo">
                        <label for="item" class="rotulo-campo">NOME DO ITEM</label>
                        <input type="text" id="item" name="item" class="campo-entrada" required>
                    </div>

                    <div class="grupo-campo">
                        <label class="rotulo-campo">DESTINO</label>

                        <div class="grupo-radio">
                            <input type="radio" name="destino" id="robotica" value="robotica" required>
                            <label for="robotica" class="rotulo-radio">Robótica</label>

                            <input type="radio" name="destino" id="manutencao" value="manutencao">
                            <label for="manutencao" class="rotulo-radio borda-esquerda">Manutenção</label>
                        </div>
                    </div>

                    <div class="grupo-campo">
                        <label for="projeto" class="rotulo-campo">
                            Projeto <span class="texto-opcional">(OPCIONAL)</span>
                        </label>

                        <div class="container-select">
                            <select id="projeto" name="projeto" class="campo-entrada select-customizado">
                                <option value="" selected disabled hidden></option>
                                <option value="projeto1">Projeto 1</option>
                                <option value="projeto2">Projeto 2</option>
                                <option value="projeto3">Projeto 3</option>
                            </select>

                            <div class="icone-seta">
                                <img src="../../assets/icons/icon-seta.svg" alt="Ícone seta">
                            </div>
                        </div>
                    </div>

                    <div class="grupo-campo">
                        <label for="observacoes" class="rotulo-campo">
                            OBSERVAÇÕES <span class="texto-opcional">(OPCIONAL)</span>
                        </label>
                        <textarea id="observacoes" name="observacoes" class="campo-texto" rows="4"></textarea>
                    </div>

                    <button type="submit" class="botao">SALVAR</button>

                </form>
            </section>
        </main>
    </div>
    <script>
    // 1. Ao carregar a página, preenche o formulário
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        
        // Pega o ID (importante para saber qual item atualizar no banco)
        const idMaterial = params.get('id');
        if (!idMaterial) {
            alert('ID do material não encontrado!');
            window.location.href = 'listar-materiais.html';
            return;
        }

        // Preenche Nome
        if(params.get('nome')) document.getElementById('item').value = params.get('nome');

        // Preenche Destino (Radio Buttons)
        const destinoVal = params.get('destino');
        if (destinoVal === 'robotica') {
            document.getElementById('robotica').checked = true;
        } else if (destinoVal === 'manutencao') {
            document.getElementById('manutencao').checked = true;
        }

        // Preenche Projeto (Select)
        const projetoVal = params.get('projeto');
        const selectProjeto = document.getElementById('projeto');
        if (projetoVal && projetoVal !== '-' && projetoVal !== 'null') {
            selectProjeto.value = projetoVal;
        }

        // Preenche Observações
        const obsVal = params.get('obs');
        if (obsVal && obsVal !== '-' && obsVal !== 'null') {
            document.getElementById('observacoes').value = obsVal;
        }

        // Armazena o ID em um atributo data do formulário para usar no envio
        document.getElementById('formulario').dataset.id = idMaterial;
    });

    // 2. Lógica de Envio (Atualização)
    document.getElementById('formulario').addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = e.target.dataset.id;
        const itemNome = document.getElementById('item').value;
        const destino = document.querySelector('input[name="destino"]:checked')?.value;
        const projeto = document.getElementById('projeto').value;
        const observacoes = document.getElementById('observacoes').value;

        const dadosAtualizados = {
            id: id, // O ID não muda, mas serve para identificar o registro
            item: itemNome,
            destino: destino,
            projeto: projeto,
            observacoes: observacoes
        };

        try {
            const response = await fetch('http://localhost:3000/api/atualizar', {
                method: 'PUT', // Usamos PUT para atualização
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dadosAtualizados)
            });

            const result = await response.json();

            if (result.success) {
                alert('Material atualizado com sucesso!');
                
                // Redireciona de volta para a etiqueta gerada com os NOVOS dados
                const params = new URLSearchParams({
                    id: String(id).padStart(4, '0'), // Mantém a formatação visual
                    nome: dadosAtualizados.item,
                    destino: dadosAtualizados.destino,
                    projeto: dadosAtualizados.projeto || '-',
                    obs: dadosAtualizados.observacoes || '-',
                    cod: 'MAT-' + String(id).padStart(4, '0')
                });
                
                window.location.href = `etiqueta-gerada.html?${params.toString()}`;
            } else {
                alert('Erro ao atualizar: ' + result.error);
            }
        } catch (err) {
            console.error(err);
            alert('Erro de conexão com o servidor.');
        }
    });
</script>
</body>
</html>
