<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Material</title>
    <link rel="stylesheet" href="../../assets/css/global.css">
    <link rel="stylesheet" href="../../assets/css/material-screen/cadastrar-material.css">
</head>

<body>
    <div class="container-geral">

        <header class="cabecalho">
            <h1 class="titulo-pagina">CADASTRAR <br> MATERIAL</h1>

            <button class="botao-fechar" type="button" aria-label="Fechar janela" onclick="window.location.href='listar-materiais.html'">
                <img src="../../assets/icons/botao-fechar.svg" alt="Botão fechar">
            </button>
        </header>

        <main class="conteudo-principal">
            <section class="secao-formulario">

                <form id="formulario" class="formulario" action="#" method="POST">

                    <div class="grupo-campo">
                        <label for="item" class="rotulo-campo">NOME DO ITEM</label>
                        <input type="text" id="item" name="item" class="campo-entrada" required>
                    </div>

                    <div class="grupo-campo">
                        <label class="rotulo-campo">DESTINO</label>

                        <div class="grupo-radio">
                            <input type="radio" name="destino" id="robotica" value="robotica" required>
                            <label for="robotica" class="rotulo-radio">Robótica</label>

                            <input type="radio" name="destino" id="manutencao" value="manutencao">
                            <label for="manutencao" class="rotulo-radio borda-esquerda">Manutenção</label>
                        </div>
                    </div>

                    <div class="grupo-campo">
                        <label for="projeto" class="rotulo-campo">
                            Projeto <span class="texto-opcional">(OPCIONAL)</span>
                        </label>

                        <div class="container-select">
                            <select id="projeto" name="projeto" class="campo-entrada select-customizado">
                                <option value="" selected disabled hidden>Carregando...</option>
                            </select>

                            <div class="icone-seta">
                                <img src="../../assets/icons/icon-seta.svg" alt="Ícone seta">
                            </div>
                        </div>
                    </div>

                    <div class="grupo-campo">
                        <label for="observacoes" class="rotulo-campo">
                            OBSERVAÇÕES <span class="texto-opcional">(OPCIONAL)</span>
                        </label>
                        <textarea id="observacoes" name="observacoes" class="campo-texto" rows="4"></textarea>
                    </div>

                    <button type="submit" class="botao">GERAR ETIQUETA</button>

                </form>

                <a href="listar-materiais.html" class="botao" style="background-color: #666; margin-top: 10px; text-align:center; text-decoration:none; display:block;">
                    VER ESTOQUE
                </a>
            </section>
        </main>
    </div>
    
    <script>
        // --- FUNÇÃO PARA CARREGAR PROJETOS DO BANCO DE DADOS ---
        async function carregarProjetos() {
            try {
                // Chama a nova rota criada no server.js
                const response = await fetch('http://localhost:3000/api/projetos');
                const projetos = await response.json();

                const selectProjeto = document.getElementById('projeto');

                // Limpa opções antigas e coloca o placeholder vazio
                selectProjeto.innerHTML = '<option value="" selected disabled hidden></option>';

                // Adiciona cada projeto retornado do banco
                projetos.forEach(proj => {
                    const option = document.createElement('option');
                    // Aqui usamos o nome do projeto como valor. 
                    // Se preferir salvar o ID no banco, mude option.value = proj.id;
                    option.value = proj.nome_projeto; 
                    option.textContent = proj.nome_projeto;
                    selectProjeto.appendChild(option);
                });
            } catch (err) {
                console.error('Erro ao carregar projetos:', err);
                const selectProjeto = document.getElementById('projeto');
                selectProjeto.innerHTML = '<option value="" disabled>Erro ao carregar</option>';
            }
        }

        // Executa a função assim que a página termina de carregar
        window.onload = carregarProjetos;

        // --- LÓGICA DE CADASTRO DE MATERIAL (MANTIDA) ---
        document.getElementById('formulario').addEventListener('submit', async (e) => {
            e.preventDefault(); // Evita que a página recarregue

            const itemNome = document.getElementById('item').value;
            
            const destinoSelecionado = document.querySelector('input[name="destino"]:checked');
            const destino = destinoSelecionado ? destinoSelecionado.value : null;

            const projeto = document.getElementById('projeto').value;
            const observacoes = document.getElementById('observacoes').value;

            const dados = {
                item: itemNome,
                destino: destino,
                projeto: projeto,
                observacoes: observacoes
            };

            try {
                const response = await fetch('http://localhost:3000/api/cadastrar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                const result = await response.json();

                if (result.success) {
                    // Formata o ID para ter 4 dígitos (ex: 0001)
                    const idFormatado = String(result.id).padStart(4, '0');

                    const params = new URLSearchParams({
                        id: idFormatado,
                        nome: dados.item,
                        destino: dados.destino,
                        projeto: dados.projeto || '-', 
                        obs: dados.observacoes || '-', 
                        cod: 'MAT-' + idFormatado
                    });

                    window.location.href = `etiqueta-gerada.html?${params.toString()}`;
                } else {
                    alert('Erro ao cadastrar: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (err) {
                console.error(err);
                alert('Erro de conexão. Verifique se o servidor (server.js) está rodando.');
            }
        });
    </script>
</body>
</html>